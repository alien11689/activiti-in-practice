<?xml version="1.0" encoding="UTF-8"?>

<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:activiti="http://activiti.org/bpmn"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             typeLanguage="http://www.w3.org/2001/XMLSchema"
             expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/test">

    <process id="person-validation">

        <startEvent id="start"/>
        <sequenceFlow sourceRef="start" targetRef="personValidation"/>
        <subProcess id="personValidation">
            <startEvent id="validationStart"/>
            <sequenceFlow sourceRef="validationStart" targetRef="validateFirstName"/>
            <serviceTask id="validateFirstName"
                         activiti:expression="#{personValidator.validateWithPossibleNull(firstName)}"
                         activiti:resultVariableName="validFirstName"/>
            <sequenceFlow sourceRef="validateFirstName" targetRef="validateLastName"/>
            <serviceTask id="validateLastName" activiti:expression="#{personValidator.validateWithoutNull(lastName)}"
                         activiti:resultVariableName="validLastName"/>
            <sequenceFlow sourceRef="validateLastName" targetRef="validationEnd">
                <conditionExpression xsi:type="tFormalExpression">
                    <![CDATA[${validFirstName && validLastName}]]>
                </conditionExpression>
            </sequenceFlow>
            <endEvent id="validationEnd"/>

            <sequenceFlow sourceRef="validateLastName" targetRef="invalidPersonEnd">
                <conditionExpression xsi:type="tFormalExpression">
                    <![CDATA[${!validFirstName || !validLastName}]]>
                </conditionExpression>
            </sequenceFlow>
            <endEvent id="invalidPersonEnd">
                <errorEventDefinition errorRef="InvalidPerson"/>
            </endEvent>

            <subProcess id="invalidPersonHandler" triggeredByEvent="true">
                <startEvent id="handlerStart">
                    <errorEventDefinition errorRef="InvalidPerson"/>
                </startEvent>
                <sequenceFlow sourceRef="handlerStart" targetRef="fixPersonData"/>
                <scriptTask id="fixPersonData" scriptFormat="groovy" activiti:autoStoreVariables="true">
                    <script>
                        lastName = "Testowski"
                        firstName = "Jan"
                    </script>
                </scriptTask>
                <sequenceFlow sourceRef="fixPersonData" targetRef="handlerEnd"/>
                <endEvent id="handlerEnd"/>
            </subProcess>

            <sequenceFlow sourceRef="invalidPersonHandler" targetRef="validationEnd"/>
        </subProcess>

        <sequenceFlow sourceRef="personValidation" targetRef="end"/>
        <endEvent id="end"/>
    </process>

    <error id="InvalidPerson" errorCode="InvalidPerson"/>

</definitions>
